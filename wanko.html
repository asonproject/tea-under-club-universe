<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ワンコ通信 ジェネレーター v1.4</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f0f0; padding: 20px; margin: 0; }
        .controls { background: white; padding: 15px; border-radius: 12px; display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; width: 90%; max-width: 600px; text-align: left; }
        .control-group { margin-bottom: 10px; }
        label { font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px; color: #333; }
        input[type="text"] { width: 95%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        input[type="range"] { width: 100%; cursor: pointer; }
        button { width: 100%; padding: 12px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 4px; font-weight: bold; margin-top: 10px; font-size: 16px; }
        #canvas-container { position: relative; display: inline-block; background: white; border: 2px solid #333; cursor: crosshair; margin-top: 10px; }
        canvas { max-width: 100%; height: auto; display: block; touch-action: none; }
        .version { font-size: 12px; color: #999; margin-top: 10px; }
        h3 { margin-top: 0; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .hint-text { font-size: 11px; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

<div class="controls">
    <h3>ワンコ通信 ジェネレーター <small>v1.4</small></h3>
    
    <div class="control-group">
        <label>① 画像設定（自動で基本画像を読み込んでいます）</label>
        <input type="file" id="bgUpload" accept="image/*">
        <div class="hint-text">※別の画像を使いたい場合のみ選択してください</div>
    </div>

    <div class="control-group">
        <label>② タイトル入力</label>
        <input type="text" id="line1" placeholder="1行目" value="成長とともに">
        <input type="text" id="line2" placeholder="2行目" value="外れていくもの">
    </div>

    <div class="control-group">
        <label>③ タイトルの行間調整</label>
        <input type="range" id="gapRange" min="0.5" max="2.5" step="0.05" value="1.3">
    </div>

    <button onclick="downloadImage()" style="background:#2196F3;">画像として完成・保存</button>
</div>

<div id="canvas-container">
    <canvas id="myCanvas"></canvas>
</div>

<div class="version">App Version 1.4.0 - GitHub画像自動読み込み対応</div>

<script>
// 七十二候データ
const kouData = [
    {n:"東風解凍", k:"はるかぜこおりをとく"}, {n:"黄鶯睍睆", k:"うぐいすなく"}, {n:"魚上氷", k:"うおこおりをいずる"},
    {n:"土脈潤起", k:"つちのしょううるおいおこる"}, {n:"霞始靆", k:"かすみはじめてたなびく"}, {n:"草木萌動", k:"そうもくめばえいずる"},
    {n:"啓蟄", k:"けいちつ"}, {n:"桃始笑", k:"ももはじめてわらう"}, {n:"倉庚鳴", k:"うぐいすなく"},
    {n:"玄鳥至", k:"つばめきたる"}, {n:"鴻雁北", k:"こうがんかえる"}, {n:"虹始見", k:"にじはじめてあらわる"},
    {n:"葭始生", k:"あしはじめてしょうず"}, {n:"霜止出苗", k:"しもやみてなえいづる"}, {n:"牡丹華", k:"ぼたんはなさく"},
    {n:"蚯蚓出", k:"みみずいづる"}, {n:"竹笋生", k:"たけのこしょうず"}, {n:"蚕起食桑", k:"かいこおきてくわをはむ"},
    {n:"小満", k:"しょうまん"}, {n:"紅花栄", k:"べにばなさく"}, {n:"麦秋至", k:"むぎのときいたる"},
    {n:"蟷螂生", k:"かまきりしょうず"}, {n:"腐草為蛍", k:"くされたるくさほたるとなる"}, {n:"梅子黄", k:"うめのみきばむ"},
    {n:"夏至", k:"げし"}, {n:"乃東枯", k:"なつかれくさかる"}, {n:"菖蒲華", k:"あやめはなさく"},
    {n:"温風至", k:"あつかぜいたる"}, {n:"蓮始開", k:"はすはじめてひらく"}, {n:"鷹乃学習", k:"たかすなわちわざをならう"},
    {n:"大暑", k:"たいしょ"}, {n:"桐始結花", k:"きりははじめてはなをむすぶ"}, {n:"土潤溽暑", k:"つちうるおうてむしあつし"},
    {n:"大雨時行", k:"たいうときどきふる"}, {n:"涼風至", k:"すずかぜいたる"}, {n:"寒蝉鳴", k:"ひぐらしなく"},
    {n:"立秋", k:"りっしゅう"}, {n:"蒙霧升降", k:"ふかききりまつおう"}, {n:"綿柎開", k:"わたのはなしべひらく"},
    {n:"草露白", k:"くさのつゆしろし"}, {n:"鶺鴒鳴", k:"せきれいなく"}, {n:"玄鳥去", k:"つばめさる"},
    {n:"白露", k:"はくろ"}, {n:"群鳥養羞", k:"むらとりじをたくわえる"}, {n:"雷乃収声", k:"かみなりすなわちこえをおさめる"},
    {n:"鴻雁来", k:"こうがんきたる"}, {n:"菊花開", k:"きくのはなひらく"}, {n:"蟋蟀在戸", k:"きりぎりすとにあり"},
    {n:"寒露", k:"かんろ"}, {n:"霜始降", k:"しもはじめてふる"}, {n:"霎時施", k:"こさめときどきふる"},
    {n:"山茶始開", k:"つばきはじめてひらく"}, {n:"地始凍", k:"ちはじめてこおる"}, {n:"金盞香", k:"きんせんかさく"},
    {n:"立冬", k:"りっとう"}, {n:"朔風払葉", k:"きたかぜこのはをはらう"}, {n:"橘始黄", k:"たちばなはじめてきばむ"},
    {n:"閉塞成冬", k:"そらさむくふゆとなる"}, {n:"鹿角解", k:"しかのつのおつる"}, {n:"雪下出麦", k:"ゆきわたりてむぎのびる"},
    {n:"小雪", k:"しょうせつ"}, {n:"芹乃栄", k:"せりすなわちさかう"}, {n:"水泉動", k:"しみずあたたかをふくむ"},
    {n:"雉始雊", k:"きじはじめてなく"}, {n:"款冬華", k:"ふきのはなはなさく"}, {n:"水沢腹堅", k:"さわみずこおりつめる"},
    {n:"大寒", k:"たいかん"}, {n:"鶏始乳", k:"にわとりはじめてとやにつく"}, {n:"征鳥厲疾", k:"せいちょうはげしくすばやし"},
    {n:"東風解凍", k:"はるかぜこおりをとく"}
];

function getKouInfo() {
    const now = new Date();
    const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    const index = Math.floor(dayOfYear / 5.07) % 72;
    return { name: kouData[index].n, kana: kouData[index].k, num: index + 1 };
}

const canvas = document.getElementById('myCanvas');
const ctx = canvas.getContext('2d');
let bgImg = new Image();
let kou = getKouInfo();

let pos = {
    kana: { x: 0, y: 0 },
    kou: { x: 0, y: 0 },
    title: { x: 0, y: 0 },
    isDragging: false,
    target: null
};

// --- 初期設定：GitHubの画像を自動読み込み ---
const defaultImageUrl = "https://raw.githubusercontent.com/asonproject/tea-under-club-universe/main/assets/issue2_base.jpg"; // 仮の直接リンク。Issueから抽出したURLを反映

// 画像の読み込み処理
function loadAndDraw(src) {
    bgImg.crossOrigin = "Anonymous"; // 保存時のエラー回避
    bgImg.src = src;
    bgImg.onload = () => {
        canvas.width = bgImg.width;
        canvas.height = bgImg.height;
        const cx = canvas.width / 2;
        // 未設定の場合のみ初期位置をセット
        if(pos.kana.x === 0) {
            pos.kana = { x: cx, y: canvas.height * 0.18 };
            pos.kou = { x: cx, y: canvas.height * 0.25 };
            pos.title = { x: cx, y: canvas.height * 0.55 };
        }
        draw();
    };
}

// 起動時にIssueの画像（URL）を読み込む
// ※ GitHubのIssue内画像URLは期限があるため、実際のリポジトリ内の画像URLに置き換えると永続します。
loadAndDraw("https://private-user-images.githubusercontent.com/5318819/555159433-5520e3c0-42c0-41e1-ab42-c3149e3f98ac.jpeg?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NzIwODEwNjMsIm5iZiI6MTc3MjA4MDc2MywicGF0aCI6Ii81MzE4ODE5LzU1NTE1OTQzMy01NTIwZTNjMC00MmMwLTQxZTEtYWI0Mi1jMzE0OWUzZjk4YWMuanBlZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAyMjYlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMjI2VDA0MzkyM1omWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTdiZDhhMjRhZDUzOWFlYTUzMjkyZTYyZDY1NGY2YzgxZjRkMzc3N2E5ZjlkZWE5NDViZjhmZDQ2ODQxMTcyOGUmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.eHi0dcYHwZ2-pzlaS0QdCGyFavRza_UNjpBLtuhKx2s");

document.getElementById('bgUpload').onchange = function(e) {
    const reader = new FileReader();
    reader.onload = (event) => loadAndDraw(event.target.result);
    reader.readAsDataURL(e.target.files[0]);
};

function draw() {
    if (!bgImg.src) return;
    ctx.drawImage(bgImg, 0, 0);
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    const kouFontSize = canvas.width * 0.055;
    const kanaFontSize = kouFontSize * 0.35;
    ctx.font = `bold ${kanaFontSize}px sans-serif`;
    ctx.fillStyle = "white";
    ctx.fillText(kou.kana, pos.kana.x, pos.kana.y);

    ctx.font = `bold ${kouFontSize}px sans-serif`;
    ctx.fillText(`〜 第${kou.num}候「${kou.name}」 〜`, pos.kou.x, pos.kou.y);

    const line1 = document.getElementById('line1').value;
    const line2 = document.getElementById('line2').value;
    const titleSize = canvas.width * 0.10;
    const gapMultiplier = document.getElementById('gapRange').value;
    const lineGap = titleSize * gapMultiplier;

    drawTitleText(line1, pos.title.x, pos.title.y, titleSize);
    if(line2) {
        drawTitleText(line2, pos.title.x, pos.title.y + lineGap, titleSize);
    }
    
    ctx.font = "20px Arial";
    ctx.fillStyle = "rgba(255,255,255,0.4)";
    ctx.textAlign = "right";
    ctx.fillText("v1.4", canvas.width - 20, canvas.height - 20);
}

function drawTitleText(text, x, y, fontSize) {
    ctx.font = `bold ${fontSize}px sans-serif`;
    ctx.textAlign = "center";
    ctx.shadowBlur = 12;
    ctx.shadowOffsetX = 6;
    ctx.shadowOffsetY = 6;
    ctx.shadowColor = "#FF4500";
    ctx.fillStyle = "white";
    ctx.fillText(text, x, y);
    ctx.shadowBlur = 4;
    ctx.fillText(text, x, y);
    ctx.shadowColor = "transparent";
}

document.getElementById('line1').oninput = draw;
document.getElementById('line2').oninput = draw;
document.getElementById('gapRange').oninput = draw;

function getCanvasPos(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return {
        x: (clientX - rect.left) * (canvas.width / rect.width),
        y: (clientY - rect.top) * (canvas.height / rect.height)
    };
}

const handleStart = (e) => {
    if (!bgImg.src) return;
    const m = getCanvasPos(e);
    const distKana = Math.sqrt((m.x - pos.kana.x)**2 + (m.y - pos.kana.y)**2);
    const distKou = Math.sqrt((m.x - pos.kou.x)**2 + (m.y - pos.kou.y)**2);
    const distTitle = Math.sqrt((m.x - pos.title.x)**2 + (m.y - pos.title.y)**2);

    if (distKana < 80) { pos.target = 'kana'; pos.isDragging = true; }
    else if (distKou < 120) { pos.target = 'kou'; pos.isDragging = true; }
    else if (distTitle < 200) { pos.target = 'title'; pos.isDragging = true; }
};

const handleMove = (e) => {
    if (!pos.isDragging) return;
    e.preventDefault();
    const m = getCanvasPos(e);
    pos[pos.target].x = m.x;
    pos[pos.target].y = m.y;
    draw();
};

canvas.addEventListener('mousedown', handleStart);
window.addEventListener('mousemove', handleMove);
window.addEventListener('mouseup', () => pos.isDragging = false);
canvas.addEventListener('touchstart', handleStart, {passive: false});
window.addEventListener('touchmove', handleMove, {passive: false});
window.addEventListener('touchend', () => pos.isDragging = false);

function downloadImage() {
    const link = document.createElement('a');
    link.download = `wanko_v1.4.png`;
    link.href = canvas.toDataURL("image/png");
    link.click();
}
</script>
</body>
</html>
