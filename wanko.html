<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ワンコ通信 ジェネレーター v1.5.1</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f0f0; padding: 20px; margin: 0; }
        .controls { background: white; padding: 15px; border-radius: 12px; display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; width: 95%; max-width: 600px; text-align: left; }
        .control-group { margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        label { font-size: 13px; font-weight: bold; display: block; margin-bottom: 5px; color: #333; }
        input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 4px; font-size: 14px; }
        input[type="range"] { width: 100%; cursor: pointer; margin-top: 5px; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; font-size: 14px; background: #fff3e0; padding: 8px; border-radius: 6px; border: 1px dashed #ff9800; }
        button { width: 100%; padding: 15px; cursor: pointer; background: #2196F3; color: white; border: none; border-radius: 6px; font-weight: bold; margin-top: 10px; font-size: 16px; }
        #canvas-container { position: relative; display: inline-block; background: white; border: 2px solid #333; cursor: crosshair; margin-top: 10px; }
        canvas { max-width: 100%; height: auto; display: block; touch-action: none; }
        .version { font-size: 11px; color: #bbb; margin-top: 10px; text-align: center; }
        h3 { margin: 0 0 10px 0; text-align: center; color: #444; border-bottom: 2px solid #4CAF50; padding-bottom: 8px; }
    </style>
</head>
<body>

<div class="controls">
    <h3>ワンコ通信 作成ツール <small>v1.5.1</small></h3>
    
    <div class="control-group">
        <label>① 画像をアップロード</label>
        <input type="file" id="bgUpload" accept="image/*">
    </div>

    <div class="control-group">
        <label>② お知らせ内容（最大4行）</label>
        <div class="checkbox-group" style="margin-bottom:8px;">
            <input type="checkbox" id="showBox" onchange="draw()"> 
            <span style="color:#e65100;">背景に緑の帯（お知らせ枠）をつける場合はチェック</span>
        </div>
        <input type="text" id="info1" placeholder="お知らせ1行目" value="〜 第六十八候「水泉動」 〜" oninput="draw()">
        <input type="text" id="info2" placeholder="お知らせ2行目" value="しみずあたたかをふくむ" oninput="draw()">
        <input type="text" id="info3" placeholder="3行目" value="" oninput="draw()">
        <input type="text" id="info4" placeholder="4行目" value="" oninput="draw()">
    </div>

    <div class="control-group">
        <label>③ 赤タイトル入力（ドラッグ移動・行間調整）</label>
        <input type="text" id="line1" placeholder="タイトル1行目" value="成長とともに" oninput="draw()">
        <input type="text" id="line2" placeholder="タイトル2行目" value="外れていくもの" oninput="draw()">
        <input type="range" id="gapRange" min="0.5" max="2.5" step="0.05" value="1.3" oninput="draw()">
    </div>

    <button onclick="downloadImage()">画像を保存する</button>
</div>

<div id="canvas-container">
    <canvas id="myCanvas"></canvas>
</div>

<div class="version">App Version 1.5.1 / No-Box Default Mode</div>

<script>
const canvas = document.getElementById('myCanvas');
const ctx = canvas.getContext('2d');
let bgImg = new Image();

let pos = {
    infoArea: { x: 0, y: 0 },
    titleArea: { x: 0, y: 0 },
    isDragging: false,
    target: null
};

document.getElementById('bgUpload').onchange = function(e) {
    const reader = new FileReader();
    reader.onload = function(event) {
        bgImg.src = event.target.result;
        bgImg.onload = () => {
            canvas.width = bgImg.width;
            canvas.height = bgImg.height;
            const cx = canvas.width / 2;
            pos.infoArea = { x: cx, y: canvas.height * 0.22 };
            pos.titleArea = { x: cx, y: canvas.height * 0.55 };
            draw();
        };
    };
    reader.readAsDataURL(e.target.files[0]);
};

function draw() {
    if (!bgImg.src) return;
    ctx.drawImage(bgImg, 0, 0);
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    const infoLines = [
        document.getElementById('info1').value,
        document.getElementById('info2').value,
        document.getElementById('info3').value,
        document.getElementById('info4').value
    ].filter(text => text !== "");

    const infoFontSize = canvas.width * 0.045;
    const infoLineGap = infoFontSize * 1.2;

    // 緑の帯の描画（チェックが入っている時だけ）
    if(document.getElementById('showBox').checked) {
        ctx.fillStyle = "rgba(0, 100, 0, 0.45)"; 
        const boxPadding = 40;
        const boxHeight = (infoLines.length * infoLineGap) + boxPadding;
        ctx.fillRect(0, pos.infoArea.y - boxHeight/2 + (infoLineGap/2), canvas.width, boxHeight);
    }

    // 文字（お知らせ）
    ctx.fillStyle = "white";
    ctx.shadowBlur = 0;
    ctx.font = `bold ${infoFontSize}px sans-serif`;
    infoLines.forEach((text, i) => {
        ctx.fillText(text, pos.infoArea.x, pos.infoArea.y + (i * infoLineGap));
    });

    // タイトル
    const line1 = document.getElementById('line1').value;
    const line2 = document.getElementById('line2').value;
    const titleSize = canvas.width * 0.10;
    const gapMultiplier = document.getElementById('gapRange').value;
    const titleLineGap = titleSize * gapMultiplier;

    drawTitleText(line1, pos.titleArea.x, pos.titleArea.y, titleSize);
    if(line2) {
        drawTitleText(line2, pos.titleArea.x, pos.titleArea.y + titleLineGap, titleSize);
    }

    ctx.font = "20px Arial";
    ctx.fillStyle = "rgba(255,255,255,0.3)";
    ctx.textAlign = "right";
    ctx.fillText("v1.5.1", canvas.width - 20, canvas.height - 20);
}

function drawTitleText(text, x, y, fontSize) {
    ctx.font = `bold ${fontSize}px sans-serif`;
    ctx.textAlign = "center";
    ctx.shadowBlur = 12;
    ctx.shadowOffsetX = 6;
    ctx.shadowOffsetY = 6;
    ctx.shadowColor = "#FF4500"; 
    ctx.fillStyle = "white";
    ctx.fillText(text, x, y);
    ctx.shadowBlur = 4;
    ctx.fillText(text, x, y);
    ctx.shadowColor = "transparent";
}

function getCanvasPos(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return {
        x: (clientX - rect.left) * (canvas.width / rect.width),
        y: (clientY - rect.top) * (canvas.height / rect.height)
    };
}

const handleStart = (e) => {
    if (!bgImg.src) return;
    const m = getCanvasPos(e);
    const dInfo = Math.sqrt((m.x - pos.infoArea.x)**2 + (m.y - pos.infoArea.y)**2);
    const dTitle = Math.sqrt((m.x - pos.titleArea.x)**2 + (m.y - pos.titleArea.y)**2);
    if (dInfo < 150) { pos.target = 'infoArea'; pos.isDragging = true; }
    else if (dTitle < 200) { pos.target = 'titleArea'; pos.isDragging = true; }
};

const handleMove = (e) => {
    if (!pos.isDragging) return;
    e.preventDefault();
    const m = getCanvasPos(e);
    pos[pos.target].x = m.x;
    pos[pos.target].y = m.y;
    draw();
};

canvas.addEventListener('mousedown', handleStart);
window.addEventListener('mousemove', handleMove);
window.addEventListener('mouseup', () => pos.isDragging = false);
canvas.addEventListener('touchstart', handleStart, {passive: false});
window.addEventListener('touchmove', handleMove, {passive: false});
window.addEventListener('touchend', () => pos.isDragging = false);

function downloadImage() {
    const link = document.createElement('a');
    link.download = `wanko_v1.5.1.png`;
    link.href = canvas.toDataURL("image/png");
    link.click();
}
</script>
</body>
</html>
